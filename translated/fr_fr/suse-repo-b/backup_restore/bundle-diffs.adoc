= Générer des diffs pour ignorer les GitRepos modifiés
:revdate: 2025-07-23
:page-revdate: {revdate}

La livraison continue dans Rancher est alimentée par la flotte. Lorsqu'un utilisateur ajoute un GitRepo CR, Continuous Delivery crée les bundles de flotte associés.

Vous pouvez accéder à ces paquets en naviguant vers l'explorateur de cluster (interface utilisateur du tableau de bord) et en sélectionnant la section `+Bundles+`.

Les chartes regroupées peuvent contenir certains objets qui sont modifiés à l'exécution, par exemple dans ValidatingWebhookConfiguration, le site `+caBundle+` est vide et le certificat d'autorité de certification est injecté par le cluster.

Le statut du bundle et du GitRepo associé est donc indiqué comme "Modifié"

image::ModifiedGitRepo.png[Statique, 600]

Offre groupée associée

image::ModifiedBundle.png[Statique, 600]

{product_name} prennent en charge la possibilité de spécifier un jsonPointer personnalisé http://jsonpatch.com/[patch].

Grâce à ce correctif, les utilisateurs peuvent demander à la flotte d'ignorer les modifications apportées aux objets.

== Exemple simple

Dans cet exemple simple, nous créons un Service et un ConfigMap auxquels nous appliquons un bundle diff.

https://github.com/rancher/fleet-test-data/tree/master/bundle-diffs

== Exemple de portier

Dans cet exemple, nous essayons de déployer opa-gatekeeper en utilisant Continuous Delivery sur nos clusters.

Le paquet opa-gatekeeper associé à l'opa GitRepo est dans un état modifié.

Chaque chemin dans le CR GitRepo est associé à un CR Bundle. L'utilisateur peut visualiser les offres groupées et les différences associées nécessaires dans le statut de l'offre groupée.

Dans notre cas, les différences détectées sont les suivantes :

[,yaml]
----
  summary:
    desiredReady: 1
    modified: 1
    nonReadyResources:
    - bundleState: Modified
      modifiedStatus:
      - apiVersion: admissionregistration.k8s.io/v1
        kind: ValidatingWebhookConfiguration
        name: gatekeeper-validating-webhook-configuration
        patch: '{"$setElementOrder/webhooks":[{"name":"validation.gatekeeper.sh"},{"name":"check-ignore-label.gatekeeper.sh"}],"webhooks":[{"clientConfig":{"caBundle":"Cg=="},"name":"validation.gatekeeper.sh","rules":[{"apiGroups":["*"],"apiVersions":["*"],"operations":["CREATE","UPDATE"],"resources":["*"]}]},{"clientConfig":{"caBundle":"Cg=="},"name":"check-ignore-label.gatekeeper.sh","rules":[{"apiGroups":[""],"apiVersions":["*"],"operations":["CREATE","UPDATE"],"resources":["namespaces"]}]}]}'
      - apiVersion: apps/v1
        kind: Deployment
        name: gatekeeper-audit
        namespace: cattle-gatekeeper-system
        patch: '{"spec":{"template":{"spec":{"$setElementOrder/containers":[{"name":"manager"}],"containers":[{"name":"manager","resources":{"limits":{"cpu":"1000m"}}}],"tolerations":[]}}}}'
      - apiVersion: apps/v1
        kind: Deployment
        name: gatekeeper-controller-manager
        namespace: cattle-gatekeeper-system
        patch: '{"spec":{"template":{"spec":{"$setElementOrder/containers":[{"name":"manager"}],"containers":[{"name":"manager","resources":{"limits":{"cpu":"1000m"}}}],"tolerations":[]}}}}'
----

Sur la base de ce résumé, trois objets doivent être corrigés.

Nous les examinerons l'un après l'autre.

=== 1. ValidatingWebhookConfiguration:

Le webhook de validation gatekeeper-validating-webhook-configuration possède deux ValidatingWebhooks dans sa spécification.

Lorsque plus d'un élément du champ nécessite un correctif, ce correctif est appelé `+$setElementOrder/ELEMENTNAME+`

D'après ces informations, nous pouvons voir que les deux ValidatingWebhooks en question sont :

----
  "$setElementOrder/webhooks": [
    {
      "name": "validation.gatekeeper.sh"
    },
    {
      "name": "check-ignore-label.gatekeeper.sh"
    }
  ],
----

Dans chaque ValidatingWebhook, les champs qui doivent être ignorés sont les suivants :

----
    {
      "clientConfig": {
        "caBundle": "Cg=="
      },
      "name": "validation.gatekeeper.sh",
      "rules": [
        {
          "apiGroups": [
            "*"
          ],
          "apiVersions": [
            "*"
          ],
          "operations": [
            "CREATE",
            "UPDATE"
          ],
          "resources": [
            "*"
          ]
        }
      ]
    },
----

et

----
     {
      "clientConfig": {
        "caBundle": "Cg=="
      },
      "name": "check-ignore-label.gatekeeper.sh",
      "rules": [
        {
          "apiGroups": [
            ""
          ],
          "apiVersions": [
            "*"
          ],
          "operations": [
            "CREATE",
            "UPDATE"
          ],
          "resources": [
            "namespaces"
          ]
        }
      ]
    }
----

En résumé, nous devons ignorer les champs `+rules+` et `+clientConfig.caBundle+` dans notre spécification de correctif.

Le champ webhook dans la spécification ValidatingWebhookConfiguration est un tableau, nous devons donc adresser les éléments par leurs valeurs d'index.

image::WebhookConfigurationSpec.png[Statique, 600]

Sur la base de ces informations, notre patch diff se présenterait comme suit :

[,yaml]
----
  - apiVersion: admissionregistration.k8s.io/v1
    kind: ValidatingWebhookConfiguration
    name: gatekeeper-validating-webhook-configuration
    operations:
    - {"op": "remove", "path":"/webhooks/0/clientConfig/caBundle"}
    - {"op": "remove", "path":"/webhooks/0/rules"}
    - {"op": "remove", "path":"/webhooks/1/clientConfig/caBundle"}
    - {"op": "remove", "path":"/webhooks/1/rules"}
----

=== 2. Déploiement de gatekeeper-controller-manager :

Le déploiement de gatekeeper-controller-manager est modifié car il y a des limites et des tolérances de cpu appliquées (qui ne sont pas dans le bundle actuel).

----
{
  "spec": {
    "template": {
      "spec": {
        "$setElementOrder/containers": [
          {
            "name": "manager"
          }
        ],
        "containers": [
          {
            "name": "manager",
            "resources": {
              "limits": {
                "cpu": "1000m"
              }
            }
          }
        ],
        "tolerations": []
      }
    }
  }
}
----

Dans ce cas, il n'y a qu'un seul conteneur dans la spécification du conteneur de déploiement, et ce conteneur a des limites et des tolérances de processeur ajoutées.

Sur la base de ces informations, notre patch diff se présenterait comme suit :

[,yaml]
----
  - apiVersion: apps/v1
    kind: Deployment
    name: gatekeeper-controller-manager
    namespace: cattle-gatekeeper-system
    operations:
    - {"op": "remove", "path": "/spec/template/spec/containers/0/resources/limits/cpu"}
    - {"op": "remove", "path": "/spec/template/spec/tolerations"}
----

=== 3. Déploiement gatekeeper-audit :

Le déploiement du gatekeeper-audit est modifié de la même manière que le gatekeeper-controller-manager, avec des limites et des tolérances supplémentaires pour le processeur.

----
{
  "spec": {
    "template": {
      "spec": {
        "$setElementOrder/containers": [
          {
            "name": "manager"
          }
        ],
        "containers": [
          {
            "name": "manager",
            "resources": {
              "limits": {
                "cpu": "1000m"
              }
            }
          }
        ],
        "tolerations": []
      }
    }
  }
}
----

Comme pour gatekeeper-controller-manager, il n'y a qu'un seul conteneur dans la spécification de conteneur des déploiements, et il a des limites et des tolérances de processeur ajoutées.

Sur la base de ces informations, notre patch diff se présenterait comme suit :

[,yaml]
----
  - apiVersion: apps/v1
    kind: Deployment
    name: gatekeeper-audit
    namespace: cattle-gatekeeper-system
    operations:
    - {"op": "remove", "path": "/spec/template/spec/containers/0/resources/limits/cpu"}
    - {"op": "remove", "path": "/spec/template/spec/tolerations"}
----

=== Combiner le tout

Nous pouvons maintenant combiner tous ces correctifs comme suit :

[,yaml]
----
diff:
  comparePatches:
  - apiVersion: apps/v1
    kind: Deployment
    name: gatekeeper-audit
    namespace: cattle-gatekeeper-system
    operations:
    - {"op": "remove", "path": "/spec/template/spec/containers/0/resources/limits/cpu"}
    - {"op": "remove", "path": "/spec/template/spec/tolerations"}
  - apiVersion: apps/v1
    kind: Deployment
    name: gatekeeper-controller-manager
    namespace: cattle-gatekeeper-system
    operations:
    - {"op": "remove", "path": "/spec/template/spec/containers/0/resources/limits/cpu"}
    - {"op": "remove", "path": "/spec/template/spec/tolerations"}
  - apiVersion: admissionregistration.k8s.io/v1
    kind: ValidatingWebhookConfiguration
    name: gatekeeper-validating-webhook-configuration
    operations:
    - {"op": "remove", "path":"/webhooks/0/clientConfig/caBundle"}
    - {"op": "remove", "path":"/webhooks/0/rules"}
    - {"op": "remove", "path":"/webhooks/1/clientConfig/caBundle"}
    - {"op": "remove", "path":"/webhooks/1/rules"}
----

Nous pouvons maintenant les ajouter au bundle directement pour les tester et également les commiter sur `+fleet.yaml+` dans votre GitRepo.

Une fois ces éléments ajoutés, le GitRepo devrait être déployé et avoir le statut "actif".
